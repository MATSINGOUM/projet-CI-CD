name: CI/CD Deploy to EC2
on:
  push:
    branches: ["main"]
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repo
      uses: actions/checkout@v4
      with:
        fetch-depth: 2
    
    - name: Check for changes
      id: changes
      run: |
        echo "frontend=$(git diff --name-only HEAD^ HEAD | grep -q '^frontend/' && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
        echo "accounts=$(git diff --name-only HEAD^ HEAD | grep -q '^services/accounts-service/' && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
        echo "users=$(git diff --name-only HEAD^ HEAD | grep -q '^services/users-service/' && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
        echo "compose=$(git diff --name-only HEAD^ HEAD | grep -q '^docker-compose.yml' && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
    
    - name: Log in to Docker Hub
      if: steps.changes.outputs.frontend == 'true' || steps.changes.outputs.accounts == 'true' || steps.changes.outputs.users == 'true'
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_TOKEN }}
    
    - name: Build and push frontend
      if: steps.changes.outputs.frontend == 'true'
      run: |
        docker build -t ${{ secrets.DOCKER_USERNAME }}/projet-frontend:latest ./frontend
        docker push ${{ secrets.DOCKER_USERNAME }}/projet-frontend:latest
    
    - name: Build and push accounts-service
      if: steps.changes.outputs.accounts == 'true'
      run: |
        docker build -t ${{ secrets.DOCKER_USERNAME }}/projet-accounts:latest ./services/accounts-service
        docker push ${{ secrets.DOCKER_USERNAME }}/projet-accounts:latest
    
    - name: Build and push user-service
      if: steps.changes.outputs.users == 'true'
      run: |
        docker build -t ${{ secrets.DOCKER_USERNAME }}/projet-user:latest ./services/users-service
        docker push ${{ secrets.DOCKER_USERNAME }}/projet-user:latest
    
    - name: Prepare EC2 folder
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ubuntu
        key: ${{ secrets.EC2_KEY }}
        script: |
          mkdir -p /home/ubuntu/projet-CI-CD
    
    - name: Copy docker-compose.yml to EC2
      if: steps.changes.outputs.compose == 'true'
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ubuntu
        key: ${{ secrets.EC2_KEY }}
        source: "docker-compose.yml"
        target: "/home/ubuntu/projet-CI-CD/docker-compose.yml"
    
    - name: Deploy on EC2
      if: steps.changes.outputs.frontend == 'true' || steps.changes.outputs.accounts == 'true' || steps.changes.outputs.users == 'true' || steps.changes.outputs.compose == 'true'
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ubuntu
        key: ${{ secrets.EC2_KEY }}
        script: |
          cd /home/ubuntu/projet-CI-CD
          sudo docker compose down || true
          echo "${{ secrets.DOCKER_TOKEN }}" | sudo docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
          sudo docker compose pull
          sudo docker compose up -d